---
import BaseLayout from "@/layouts/BaseLayout.astro";
import Section from "@/components/layout/Section.astro";
import Card from "@/components/ui/Card.astro";
import { getCollection } from "astro:content";
import { t } from "@/i18n/utils";

const locale = "de";

const allTerms = (await getCollection("glossary", ({ data }) => data.locale === locale && !data.draft))
  .sort((a, b) => a.data.term.localeCompare(b.data.term));

// Get unique categories with their display names
const categoryMap = new Map<string, string>();
allTerms.forEach((term) => {
  if (!categoryMap.has(term.data.category)) {
    categoryMap.set(term.data.category, term.data.category_name);
  }
});
const categories = Array.from(categoryMap.entries());

// Get unique first letters for A-Z navigation
const letters = [...new Set(allTerms.map((term) => term.data.term.charAt(0).toUpperCase()))].sort();

// Schema markup
const glossaryUrl = `https://auryth.ai/${locale}/glossary/`;

const definedTermSetSchema = JSON.stringify({
  "@context": "https://schema.org",
  "@type": "DefinedTermSet",
  "@id": glossaryUrl,
  "name": t("glossary.title", locale) + " — Auryth TX",
  "description": t("glossary.subtitle", locale),
  "inLanguage": locale,
  "hasDefinedTerm": allTerms.map((term) => ({
    "@type": "DefinedTerm",
    "@id": `${glossaryUrl}${term.data.termSlug}/`,
    "name": term.data.term,
    "description": term.data.short,
  })),
});

const breadcrumbSchema = JSON.stringify({
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    { "@type": "ListItem", "position": 1, "name": "Startseite", "item": `https://auryth.ai/${locale}/` },
    { "@type": "ListItem", "position": 2, "name": t("glossary.title", locale), "item": glossaryUrl },
  ],
});
---

<BaseLayout
  title={`${t("glossary.title", locale)} — ${t("site.title", locale)}`}
  description={t("glossary.subtitle", locale)}
  locale={locale}
  path="/glossary/"
>
  <Fragment slot="head">
    <script is:inline type="application/ld+json" set:html={definedTermSetSchema} />
    <script is:inline type="application/ld+json" set:html={breadcrumbSchema} />
  </Fragment>

  <main id="main-content">
    <Section class="pt-12 md:pt-16 pb-16 md:pb-24">
      <div class="mx-auto max-w-3xl text-center mb-8">
        <h1 class="text-display text-foreground">{t("glossary.title", locale)}</h1>
        <p class="mt-4 text-body-lg text-muted-foreground">{t("glossary.subtitle", locale)}</p>
      </div>

      {/* Category filter */}
      <nav aria-label="Glossar-Kategorien" class="mb-6 flex flex-wrap justify-center gap-2">
        <a
          href={`/${locale}/glossary/`}
          class="rounded-full border border-primary bg-primary px-4 py-1.5 text-body-sm font-medium text-primary-foreground"
          aria-current="page"
        >
          {t("glossary.all", locale)}
        </a>
        {categories.map(([slug, name]) => (
          <a
            href={`/${locale}/glossary/category/${slug}/`}
            class="rounded-full border border-border px-4 py-1.5 text-body-sm font-medium text-foreground transition-colors hover:border-primary hover:text-primary-text"
          >
            {name}
          </a>
        ))}
      </nav>

      {/* A-Z letter navigation */}
      <nav aria-label="Alphabetische Navigation" class="mb-10 flex flex-wrap justify-center gap-1">
        {letters.map((letter) => (
          <a
            href={`#letter-${letter}`}
            class="w-8 h-8 flex items-center justify-center rounded text-body-sm font-medium text-muted-foreground hover:bg-muted hover:text-foreground transition-colors"
          >
            {letter}
          </a>
        ))}
      </nav>

      {allTerms.length > 0 ? (
        <div class="space-y-12">
          {letters.map((letter) => {
            const termsForLetter = allTerms.filter((term) => term.data.term.charAt(0).toUpperCase() === letter);
            return termsForLetter.length > 0 && (
              <section id={`letter-${letter}`}>
                <h2 class="text-heading-lg text-foreground mb-4 border-b border-border pb-2">{letter}</h2>
                <div class="grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
                  {termsForLetter.map((term) => (
                    <Card>
                      <a href={`/${locale}/glossary/${term.data.termSlug}/`} class="block group">
                        <div class="flex items-start justify-between gap-2">
                          <h3 class="text-body-lg font-semibold text-foreground group-hover:text-primary-text transition-colors">
                            {term.data.term}
                          </h3>
                          <span class="shrink-0 rounded-full bg-muted px-2 py-0.5 text-caption text-muted-foreground">
                            {term.data.category_name}
                          </span>
                        </div>
                        <p class="mt-2 text-body-sm text-muted-foreground line-clamp-2">{term.data.short}</p>
                      </a>
                    </Card>
                  ))}
                </div>
              </section>
            );
          })}
        </div>
      ) : (
        <p class="text-center text-body text-muted-foreground">Noch keine Begriffe. Schauen Sie bald wieder vorbei!</p>
      )}
    </Section>
  </main>
</BaseLayout>
