---
import BaseLayout from "@/layouts/BaseLayout.astro";
import Section from "@/components/layout/Section.astro";
import Card from "@/components/ui/Card.astro";
import { getCollection } from "astro:content";
import { t } from "@/i18n/utils";

const locale = "fr";

export const prerender = true;

export async function getStaticPaths() {
  const allPosts = await getCollection("blog", ({ data }) => data.locale === "fr" && !data.draft);
  
  // Get all unique tags with counts
  const tagCounts = new Map<string, number>();
  allPosts.forEach((post) => {
    post.data.tags.forEach((tag: string) => {
      tagCounts.set(tag, (tagCounts.get(tag) || 0) + 1);
    });
  });

  // Get categories
  const categoryMap = new Map<string, string>();
  allPosts.forEach((post) => {
    if (!categoryMap.has(post.data.category)) {
      categoryMap.set(post.data.category, post.data.category_name);
    }
  });

  return Array.from(tagCounts.keys()).map((tag) => ({
    params: { tag: tag.toLowerCase().replace(/\s+/g, "-") },
    props: { 
      originalTag: tag,
      allTags: Array.from(tagCounts.entries()).sort((a, b) => b[1] - a[1]),
      categories: Array.from(categoryMap.entries()),
    },
  }));
}

const { tag } = Astro.params;
const { originalTag, allTags, categories } = Astro.props;

const allPosts = (await getCollection("blog", ({ data }) => data.locale === locale && !data.draft))
  .filter((post) => post.data.tags.some((t: string) => t.toLowerCase().replace(/\s+/g, "-") === tag))
  .sort((a, b) => b.data.publishDate.valueOf() - a.data.publishDate.valueOf());

// Helper to create tag URL
function tagUrl(tagName: string) {
  return `/${locale}/blog/tag/${tagName.toLowerCase().replace(/\s+/g, "-")}/`;
}

// Limit displayed tags in nav
const displayedTags = allTags.slice(0, 12);
const hasMoreTags = allTags.length > 12;
---

<BaseLayout
  title={`${originalTag} — Blog — ${t("site.title", locale)}`}
  description={`Articles de blog sur ${originalTag}`}
  locale={locale}
  path={`/blog/tag/${tag}/`}
>
  <main id="main-content">
    <Section class="pt-12 md:pt-16 pb-16 md:pb-24">
      {/* Breadcrumb */}
      <nav aria-label="Breadcrumb" class="mb-6">
        <ol class="flex items-center gap-2 text-body-sm text-muted-foreground">
          <li><a href={`/${locale}/`} class="hover:text-primary-text transition-colors">Accueil</a></li>
          <li aria-hidden="true">/</li>
          <li><a href={`/${locale}/blog/`} class="hover:text-primary-text transition-colors">Blog</a></li>
          <li aria-hidden="true">/</li>
          <li class="text-foreground font-medium">#{originalTag}</li>
        </ol>
      </nav>

      <div class="mx-auto max-w-3xl text-center mb-8">
        <h1 class="text-display text-foreground">
          <span class="text-primary-text">#</span>{originalTag}
        </h1>
        <p class="mt-4 text-body-lg text-muted-foreground">{allPosts.length} article{allPosts.length !== 1 ? "s" : ""}</p>
      </div>

      {/* Category filter */}
      <nav aria-label="Catégories du blog" class="mb-6 flex flex-wrap justify-center gap-2">
        <a
          href={`/${locale}/blog/`}
          class="rounded-full border border-border px-4 py-1.5 text-body-sm font-medium text-foreground transition-colors hover:border-primary hover:text-primary-text"
        >
          Tout
        </a>
        {categories.map(([slug, name]: [string, string]) => (
          <a
            href={`/${locale}/blog/category/${slug}/`}
            class="rounded-full border border-border px-4 py-1.5 text-body-sm font-medium text-foreground transition-colors hover:border-primary hover:text-primary-text"
          >
            {name}
          </a>
        ))}
      </nav>

      {/* Tag cloud */}
      <nav aria-label="Parcourir les tags" class="mb-10">
        <div class="flex flex-wrap justify-center gap-2">
          {displayedTags.map(([tagName, count]: [string, number]) => (
            <a
              href={tagUrl(tagName)}
              class:list={[
                "text-caption hover:underline",
                tagName.toLowerCase().replace(/\s+/g, "-") === tag
                  ? "text-foreground font-medium"
                  : "text-primary-text"
              ]}
            >
              {tagName} <span class="opacity-60">({count})</span>
            </a>
          ))}
          {hasMoreTags && (
            <span class="text-caption text-muted-foreground">+{allTags.length - 12} de plus</span>
          )}
        </div>
      </nav>

      {allPosts.length > 0 ? (
        <div class="grid gap-8 sm:grid-cols-2 lg:grid-cols-3">
          {allPosts.map((post) => (
            <Card>
              <a href={`/${locale}/blog/${post.id.replace(/\.mdx?$/, "")}/`} class="block group">
                <time class="text-caption text-muted-foreground" datetime={post.data.publishDate.toISOString()}>
                  {post.data.publishDate.toLocaleDateString("fr-BE", { year: "numeric", month: "long", day: "numeric" })}
                </time>
                <h2 class="mt-2 text-body-lg font-semibold text-foreground group-hover:text-primary-text transition-colors">
                  {post.data.title}
                </h2>
                <p class="mt-2 text-body-sm text-muted-foreground">{post.data.description}</p>
                <div class="mt-3 flex flex-wrap gap-2">
                  {post.data.tags.map((t: string) => (
                    <a 
                      href={tagUrl(t)} 
                      class:list={[
                        "text-caption hover:underline",
                        t.toLowerCase().replace(/\s+/g, "-") === tag 
                          ? "text-foreground font-medium" 
                          : "text-primary-text"
                      ]}
                      onclick="event.stopPropagation()"
                    >
                      {t}
                    </a>
                  ))}
                </div>
              </a>
            </Card>
          ))}
        </div>
      ) : (
        <p class="text-center text-body text-muted-foreground">Aucun article trouvé avec ce tag.</p>
      )}
    </Section>
  </main>
</BaseLayout>
