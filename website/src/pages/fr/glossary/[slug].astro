---
import BaseLayout from "@/layouts/BaseLayout.astro";
import Section from "@/components/layout/Section.astro";
import Card from "@/components/ui/Card.astro";
import { getCollection } from "astro:content";
import { t } from "@/i18n/utils";

const locale = "fr";

export async function getStaticPaths() {
  const terms = (await getCollection("glossary", ({ data }) => data.locale === "fr" && !data.draft))
    .sort((a, b) => a.data.term.localeCompare(b.data.term));
  
  return terms.map((term, index) => ({
    params: { slug: term.data.termSlug },
    props: {
      term,
      prevTerm: index > 0 ? terms[index - 1] : null,
      nextTerm: index < terms.length - 1 ? terms[index + 1] : null,
    },
  }));
}

const { term, prevTerm, nextTerm } = Astro.props;
const { Content } = await term.render();

// Get related terms
const allTerms = await getCollection("glossary", ({ data }) => data.locale === locale && !data.draft);
const relatedTerms = allTerms.filter((t) => term.data.related.includes(t.data.termSlug));

// Schema markup
const termUrl = `https://auryth.ai/${locale}/glossary/${term.data.termSlug}/`;
const glossaryUrl = `https://auryth.ai/${locale}/glossary/`;

const definedTermSchema = JSON.stringify({
  "@context": "https://schema.org",
  "@type": "DefinedTerm",
  "@id": termUrl,
  "name": term.data.term,
  "description": term.data.short,
  ...(term.data.synonyms.length > 0 ? { "alternateName": term.data.synonyms } : {}),
  "inDefinedTermSet": {
    "@type": "DefinedTermSet",
    "@id": glossaryUrl,
    "name": "Glossaire Auryth TX",
  },
  "sameAs": [
    `https://auryth.ai/en/glossary/${term.data.termSlug}/`,
    `https://auryth.ai/nl/glossary/${term.data.termSlug}/`,
    `https://auryth.ai/de/glossary/${term.data.termSlug}/`,
  ],
});

const breadcrumbSchema = JSON.stringify({
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    { "@type": "ListItem", "position": 1, "name": "Accueil", "item": `https://auryth.ai/${locale}/` },
    { "@type": "ListItem", "position": 2, "name": t("glossary.title", locale), "item": glossaryUrl },
    { "@type": "ListItem", "position": 3, "name": term.data.term, "item": termUrl },
  ],
});
---

<BaseLayout
  title={`${term.data.term} — ${t("glossary.title", locale)} | ${t("site.title", locale)}`}
  description={term.data.short}
  locale={locale}
  path={`/glossary/${term.data.termSlug}/`}
>
  <Fragment slot="head">
    <script is:inline type="application/ld+json" set:html={definedTermSchema} />
    <script is:inline type="application/ld+json" set:html={breadcrumbSchema} />
  </Fragment>

  <main id="main-content">
    <Section class="pt-12 md:pt-16 pb-16 md:pb-24">
      <div class="mx-auto max-w-3xl">
        <nav class="flex items-center justify-between gap-4 flex-wrap">
          <a href={`/${locale}/glossary/`} class="text-body-sm text-primary-text hover:underline">
            &larr; {t("glossary.backToGlossary", locale)}
          </a>
        </nav>

        {/* Previous/Next navigation */}
        <nav class="mt-6 grid gap-4 sm:grid-cols-2">
          {prevTerm ? (
            <a
              href={`/${locale}/glossary/${prevTerm.data.termSlug}/`}
              class="group flex flex-col p-4 rounded-lg border border-border hover:border-primary transition-colors"
            >
              <span class="text-caption text-muted-foreground">&larr; Précédent</span>
              <span class="mt-1 text-body font-medium text-foreground group-hover:text-primary-text transition-colors line-clamp-2">
                {prevTerm.data.term}
              </span>
            </a>
          ) : <div />}
          {nextTerm ? (
            <a
              href={`/${locale}/glossary/${nextTerm.data.termSlug}/`}
              class="group flex flex-col p-4 rounded-lg border border-border hover:border-primary transition-colors sm:text-right"
            >
              <span class="text-caption text-muted-foreground">Suivant &rarr;</span>
              <span class="mt-1 text-body font-medium text-foreground group-hover:text-primary-text transition-colors line-clamp-2">
                {nextTerm.data.term}
              </span>
            </a>
          ) : <div />}
        </nav>

        <header class="mt-8">
          <div class="flex items-center gap-3 mb-2">
            <span class="rounded-full bg-primary/10 px-3 py-1 text-body-sm font-medium text-primary-text">
              {term.data.category_name}
            </span>
          </div>
          <h1 class="text-display text-foreground" itemprop="name">{term.data.term}</h1>
          <p class="mt-4 text-body-lg text-muted-foreground" itemprop="description">{term.data.short}</p>
          
          {term.data.synonyms.length > 0 && (
            <p class="mt-3 text-body-sm text-muted-foreground">
              <span class="font-medium">{t("glossary.alsoKnown", locale)}:</span>{" "}
              {term.data.synonyms.join(", ")}
            </p>
          )}
        </header>

        <article class="prose mt-12" itemprop="text">
          <Content />
        </article>

        {relatedTerms.length > 0 && (
          <aside class="mt-12 rounded-lg border border-border bg-card p-6">
            <h2 class="text-body-lg font-semibold text-foreground">{t("glossary.related", locale)}</h2>
            <div class="mt-4 grid gap-3 sm:grid-cols-2">
              {relatedTerms.map((related) => (
                <a
                  href={`/${locale}/glossary/${related.data.termSlug}/`}
                  class="group flex items-center gap-2 rounded-md border border-border p-3 transition-colors hover:border-primary"
                >
                  <span class="text-body font-medium text-foreground group-hover:text-primary-text transition-colors">
                    {related.data.term}
                  </span>
                  <span class="text-caption text-muted-foreground">→</span>
                </a>
              ))}
            </div>
          </aside>
        )}
      </div>
    </Section>
  </main>
</BaseLayout>
