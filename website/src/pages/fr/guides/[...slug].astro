---
import BaseLayout from "@/layouts/BaseLayout.astro";
import Section from "@/components/layout/Section.astro";
import { getCollection } from "astro:content";
import { t } from "@/i18n/utils";

const locale = "fr";

export async function getStaticPaths() {
  const guides = await getCollection("guides", ({ data }) => data.locale === "fr");
  return guides.map((guide) => ({
    params: { slug: guide.id.replace(/\.mdx?$|\.md$/, "") },
    props: { guide },
  }));
}

const { guide } = Astro.props;
const { Content } = await guide.render();

const slug = guide.id.replace(/\.mdx?$|\.md$/, "");
const guideUrl = `https://auryth.ai/${locale}/guides/${slug}/`;

const jsonLd = JSON.stringify({
  "@context": "https://schema.org",
  "@type": "Article",
  "headline": guide.data.title,
  "description": guide.data.description,
  "dateModified": guide.data.lastUpdated.toISOString(),
  "author": { "@type": "Organization", "name": "Auryth BV" },
  "publisher": { "@type": "Organization", "name": "Auryth BV", "url": "https://auryth.ai" },
  ...(guide.data.sources.length > 0 ? {
    "citation": guide.data.sources.map((s) => ({
      "@type": "CreativeWork",
      "name": s.title,
      "url": s.url,
    }))
  } : {}),
});

const breadcrumbSchema = JSON.stringify({
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    { "@type": "ListItem", "position": 1, "name": "Accueil", "item": `https://auryth.ai/${locale}/` },
    { "@type": "ListItem", "position": 2, "name": "Guides", "item": `https://auryth.ai/${locale}/guides/` },
    { "@type": "ListItem", "position": 3, "name": guide.data.title, "item": guideUrl },
  ],
});
---

<BaseLayout
  title={`${guide.data.title} — ${t("site.title", locale)}`}
  description={guide.data.description}
  locale={locale}
  path={`/guides/${slug}/`}
>
  <Fragment slot="head">
    <script is:inline type="application/ld+json" set:html={jsonLd} />
    <script is:inline type="application/ld+json" set:html={breadcrumbSchema} />
  </Fragment>

  <main id="main-content">
    <Section class="pt-12 md:pt-16">
      <div class="mx-auto max-w-3xl">
        <a href={`/${locale}/guides/`} class="text-body-sm text-primary-text hover:underline">&larr; Tous les guides</a>

        <header class="mt-8">
          <span class="text-caption text-primary-text">{guide.data.topic}</span>
          <h1 class="mt-2 text-display text-foreground">{guide.data.title}</h1>
          <p class="mt-4 text-body-lg text-muted-foreground">{guide.data.description}</p>
          <p class="mt-4 text-caption text-muted-foreground">
            Dernière mise à jour : {guide.data.lastUpdated.toLocaleDateString("fr-BE", { year: "numeric", month: "long", day: "numeric" })}
          </p>
        </header>

        <article class="prose mt-12">
          <Content />
        </article>

        {guide.data.sources.length > 0 && (
          <aside class="mt-12 rounded-lg border border-border bg-card p-6">
            <h2 class="text-body-lg font-semibold text-foreground">Sources</h2>
            <ul class="mt-4 space-y-2">
              {guide.data.sources.map((source) => (
                <li class="text-body-sm">
                  <a href={source.url} target="_blank" rel="noopener noreferrer" class="text-primary-text hover:underline">
                    {source.title}
                  </a>
                  {source.authority && <span class="text-muted-foreground"> — {source.authority}</span>}
                </li>
              ))}
            </ul>
          </aside>
        )}
      </div>
    </Section>
  </main>
</BaseLayout>
