---
import BaseLayout from "@/layouts/BaseLayout.astro";
import Section from "@/components/layout/Section.astro";
import Card from "@/components/ui/Card.astro";
import { getCollection } from "astro:content";
import { t } from "@/i18n/utils";

const locale = "nl";

export async function getStaticPaths() {
  const allTerms = await getCollection("glossary", ({ data }) => data.locale === "nl" && !data.draft);
  
  // Get unique categories
  const categoryMap = new Map<string, string>();
  allTerms.forEach((term) => {
    if (!categoryMap.has(term.data.category)) {
      categoryMap.set(term.data.category, term.data.category_name);
    }
  });
  const allCategories = Array.from(categoryMap.entries());

  return Array.from(categoryMap.entries()).map(([slug, name]) => ({
    params: { category: slug },
    props: {
      categorySlug: slug,
      categoryName: name,
      terms: allTerms.filter((term) => term.data.category === slug).sort((a, b) => a.data.term.localeCompare(b.data.term)),
      allCategories,
    },
  }));
}

const { categorySlug, categoryName, terms, allCategories } = Astro.props;

// Get unique first letters for A-Z navigation
const letters = [...new Set(terms.map((term: any) => term.data.term.charAt(0).toUpperCase()))].sort();

// Schema markup
const glossaryUrl = `https://auryth.ai/${locale}/glossary/`;
const categoryUrl = `https://auryth.ai/${locale}/glossary/category/${categorySlug}/`;

const breadcrumbSchema = JSON.stringify({
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    { "@type": "ListItem", "position": 1, "name": "Home", "item": `https://auryth.ai/${locale}/` },
    { "@type": "ListItem", "position": 2, "name": t("glossary.title", locale), "item": glossaryUrl },
    { "@type": "ListItem", "position": 3, "name": categoryName, "item": categoryUrl },
  ],
});
---

<BaseLayout
  title={`${categoryName} — ${t("glossary.title", locale)} | ${t("site.title", locale)}`}
  description={`${categoryName} termen in de Auryth TX woordenlijst. Belangrijke begrippen uitgelegd.`}
  locale={locale}
  path={`/glossary/category/${categorySlug}/`}
>
  <Fragment slot="head">
    <script is:inline type="application/ld+json" set:html={breadcrumbSchema} />
  </Fragment>

  <main id="main-content">
    <Section class="pt-12 md:pt-16 pb-16 md:pb-24">
      <div class="mx-auto max-w-3xl text-center mb-8">
        <h1 class="text-display text-foreground">{t("glossary.title", locale)}</h1>
        <p class="mt-4 text-body-lg text-muted-foreground">{t("glossary.subtitle", locale)}</p>
      </div>

      {/* Category filter */}
      <nav aria-label="Woordenlijst categorieën" class="mb-6 flex flex-wrap justify-center gap-2">
        <a
          href={`/${locale}/glossary/`}
          class="rounded-full border border-border px-4 py-1.5 text-body-sm font-medium text-foreground transition-colors hover:border-primary hover:text-primary-text"
        >
          {t("glossary.all", locale)}
        </a>
        {allCategories.map(([slug, name]: [string, string]) => (
          <a
            href={`/${locale}/glossary/category/${slug}/`}
            class:list={[
              "rounded-full border px-4 py-1.5 text-body-sm font-medium transition-colors",
              slug === categorySlug
                ? "border-primary bg-primary text-primary-foreground"
                : "border-border text-foreground hover:border-primary hover:text-primary-text",
            ]}
            aria-current={slug === categorySlug ? "page" : undefined}
          >
            {name}
          </a>
        ))}
      </nav>

      {/* A-Z letter navigation */}
      {letters.length > 0 && (
        <nav aria-label="Alfabetische navigatie" class="mb-10 flex flex-wrap justify-center gap-1">
          {letters.map((letter) => (
            <a
              href={`#letter-${letter}`}
              class="w-8 h-8 flex items-center justify-center rounded text-body-sm font-medium text-muted-foreground hover:bg-muted hover:text-foreground transition-colors"
            >
              {letter}
            </a>
          ))}
        </nav>
      )}

      {terms.length > 0 ? (
        <div class="space-y-12">
          {letters.map((letter) => {
            const termsForLetter = terms.filter((term: any) => term.data.term.charAt(0).toUpperCase() === letter);
            return termsForLetter.length > 0 && (
              <section id={`letter-${letter}`}>
                <h2 class="text-heading-lg text-foreground mb-4 border-b border-border pb-2">{letter}</h2>
                <div class="grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
                  {termsForLetter.map((term: any) => (
                    <Card>
                      <a href={`/${locale}/glossary/${term.data.termSlug}/`} class="block group">
                        <div class="flex items-start justify-between gap-2">
                          <h3 class="text-body-lg font-semibold text-foreground group-hover:text-primary-text transition-colors">
                            {term.data.term}
                          </h3>
                        </div>
                        <p class="mt-2 text-body-sm text-muted-foreground line-clamp-2">{term.data.short}</p>
                      </a>
                    </Card>
                  ))}
                </div>
              </section>
            );
          })}
        </div>
      ) : (
        <p class="text-center text-body text-muted-foreground">Nog geen termen in deze categorie.</p>
      )}
    </Section>
  </main>
</BaseLayout>
